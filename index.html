<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Car Experience</title>
    <link rel="stylesheet" href="styles.css">
    <!-- Import Three.js and other libraries from CDN -->
    <script type="module">
        import * as THREE from 'https://cdn.skypack.dev/three';
        import { GLTFLoader } from 'https://cdn.skypack.dev/three/examples/jsm/loaders/GLTFLoader.js';
        import { Water } from 'https://cdn.skypack.dev/three/examples/jsm/objects/Water.js';
        import { PointerLockControls } from 'https://cdn.skypack.dev/three/examples/jsm/controls/PointerLockControls.js';
        import * as CANNON from 'https://cdn.skypack.dev/cannon-es';

        // Scene setup
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // Lighting
        const ambientLight = new THREE.AmbientLight(0x404040);
        scene.add(ambientLight);
        const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
        directionalLight.position.set(5, 10, 7.5);
        directionalLight.castShadow = true;
        scene.add(directionalLight);

        // Water
        const waterGeometry = new THREE.PlaneBufferGeometry(10000, 10000);
        const water = new Water(waterGeometry, {
          textureWidth: 512,
          textureHeight: 512,
          waterNormals: new THREE.TextureLoader().load('textures/waternormals.jpg', function (texture) {
            texture.wrapS = texture.wrapT = THREE.RepeatWrapping;
          }),
          alpha: 1.0,
          sunDirection: directionalLight.position.clone().normalize(),
          sunColor: 0xffffff,
          waterColor: 0x001e0f,
          distortionScale: 3.7,
        });
        water.rotation.x = -Math.PI / 2;
        scene.add(water);

        // Terrain
        const groundGeometry = new THREE.PlaneGeometry(10000, 10000);
        const groundMaterial = new THREE.MeshStandardMaterial({ color: 0x228B22 });
        const ground = new THREE.Mesh(groundGeometry, groundMaterial);
        ground.rotation.x = -Math.PI / 2;
        ground.position.y = -10;
        scene.add(ground);

        // Car model
        const loader = new GLTFLoader();
        let car;
        loader.load('models/sportcar.017.glb', function (gltf) {
          car = gltf.scene;
          car.scale.set(2, 2, 2);
          car.position.y = -5;
          scene.add(car);
        });

        // Physics
        const world = new CANNON.World({
          gravity: new CANNON.Vec3(0, -9.82, 0), // m/sÂ²
        });
        const carBody = new CANNON.Body({
          mass: 1500, // kg
          shape: new CANNON.Box(new CANNON.Vec3(1, 0.5, 2)),
        });
        carBody.position.set(0, 5, 0);
        world.addBody(carBody);

        // Camera controls
        const controls = new PointerLockControls(camera, renderer.domElement);
        document.addEventListener('click', function () {
          controls.lock();
        });

        // Animation loop
        function animate() {
          requestAnimationFrame(animate);
          world.step(1 / 60);
          if (car) car.position.copy(carBody.position);
          controls.update();
          water.material.uniforms['time'].value += 1.0 / 60.0;
          renderer.render(scene, camera);
        }
        animate();
    </script>
</head>
<body>
    <div id="info">
        <div id="instructions">
            <span style="font-size:24px">Click to play</span>
            <br><br>
            Use WASD to move, SPACE to jump, MOUSE to look around.
        </div>
        <div id="hud">
            <div id="speed">Speed: 0 km/h</div>
            <div id="minimap">Minimap: Not implemented</div>
        </div>
    </div>
</body>
</html>
